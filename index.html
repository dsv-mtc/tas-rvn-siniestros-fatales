<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mapa interactivo – Siniestros fatales RVN</title>

<!-- Leaflet CSS (OBLIGATORIO) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<!-- MiniMap CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css"/>

<style>
html, body { height:100%; margin:0; }
#map { height:100vh; width:100%; }

.legend{
  background:rgba(255,255,255,0.95);
  padding:10px 12px;
  border-radius:8px;
  box-shadow:0 2px 10px rgba(0,0,0,0.15);
  font:12px/1.35 system-ui, Arial;
}
.legend-title{ font-weight:700; margin-bottom:6px; cursor:pointer; user-select:none; }
.legend-row{ display:flex; align-items:center; gap:8px; margin:4px 0; }
.swatch{
  width:14px; height:14px;
  border-radius:3px;
  border:1px solid rgba(0,0,0,0.25);
}
.legend-body{ max-height:240px; overflow-y:auto; }

.coord-box input{
  width:140px;
  padding:6px;
  margin-bottom:4px;
}
.coord-box button{
  padding:6px 10px;
  cursor:pointer;
}

@media (max-width:768px){
  .legend{ max-height:40vh; overflow-y:auto; }
}
</style>
</head>

<body>
<div id="map"></div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>

<script>
//////////////////////////////////////////////////
// MAPA BASE
//////////////////////////////////////////////////
var map = L.map('map').setView([-9.2, -75], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

//////////////////////////////////////////////////
// CONTROLES
//////////////////////////////////////////////////

// Escala dinámica (m/km según zoom)
L.control.scale({
  position:'bottomright',
  metric:true,
  imperial:false,
  maxWidth:150
}).addTo(map);

// Mini mapa
var miniLayer = new L.TileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  { minZoom:0, maxZoom:13 }
);
new L.Control.MiniMap(miniLayer,{
  toggleDisplay:true,
  minimized:true,
  position:'bottomright'
}).addTo(map);

//////////////////////////////////////////////////
// BUSCADOR DE COORDENADAS
//////////////////////////////////////////////////
var coordMarker = null;
var coordControl = L.control({ position:'bottomleft' });
coordControl.onAdd = function(){
  var div = L.DomUtil.create('div','legend coord-box');
  div.innerHTML =
    '<div class="legend-title" style="cursor:default">Ir a coordenadas</div>'+
    '<input id="latInput" placeholder="Lat (-12.0464)"><br>'+
    '<input id="lonInput" placeholder="Lon (-77.0428)"><br>'+
    '<button id="goBtn">Ir</button>';
  L.DomEvent.disableClickPropagation(div);
  return div;
};
coordControl.addTo(map);

setTimeout(function(){
  var btn = document.getElementById('goBtn');
  if (!btn) return;
  btn.onclick = function(){
    var lat = parseFloat((document.getElementById('latInput').value || '').replace(',','.'));
    var lon = parseFloat((document.getElementById('lonInput').value || '').replace(',','.'));
    if (isNaN(lat) || isNaN(lon)) { alert('Ingrese coordenadas válidas'); return; }
    map.setView([lat,lon], 16);
    if (coordMarker) map.removeLayer(coordMarker);
    coordMarker = L.marker([lat,lon]).addTo(map)
      .bindPopup('Lat: '+lat+'<br>Lon: '+lon)
      .openPopup();
  };
}, 0);

//////////////////////////////////////////////////
// PANES (ORDEN VISUAL)
//////////////////////////////////////////////////
map.createPane('paneConcesiones');   map.getPane('paneConcesiones').style.zIndex = 200;
map.createPane('paneDepartamentos'); map.getPane('paneDepartamentos').style.zIndex = 300;
map.createPane('paneRVN');           map.getPane('paneRVN').style.zIndex = 350;
map.createPane('paneClusters');      map.getPane('paneClusters').style.zIndex = 450;
map.createPane('paneTramos');        map.getPane('paneTramos').style.zIndex = 500;

//////////////////////////////////////////////////
// COLORES
//////////////////////////////////////////////////
function colorByFallecidos(v){
  if (v >= 21) return '#67000d';
  if (v >= 16) return '#a50f15';
  if (v >= 11) return '#de2d26';
  if (v >= 6)  return '#fb6a4a';
  if (v >= 1)  return '#fee5d9';
  return '#cccccc';
}

var adminColorMap = {};
var adminColors = [
  '#1f78b4','#33a02c','#e31a1c','#ff7f00','#6a3d9a',
  '#a6cee3','#b2df8a','#fb9a99','#fdbf6f','#cab2d6',
  '#8dd3c7','#ffffb3','#bebada','#fb8072','#80b1d3',
  '#fdb462','#b3de69','#fccde5','#d9d9d9','#bc80bd',
  '#ccebc5','#ffed6f','#66c2a5','#fc8d62','#8da0cb'
];
function colorByAdmin(a){
  if (!adminColorMap[a]) {
    adminColorMap[a] = adminColors[Object.keys(adminColorMap).length % adminColors.length];
  }
  return adminColorMap[a];
}

//////////////////////////////////////////////////
// CAPAS (se crean aquí para el control)
//////////////////////////////////////////////////

// Concesiones
var concesionesLayer = L.geoJSON(null,{
  pane:'paneConcesiones',
  style:function(f){
    var a = (f.properties || {}).ADM_VALIDO || 'No especificado';
    return { color: colorByAdmin(a), weight: 4.5, opacity: 0.75 };
  },
  onEachFeature:function(f,l){
    var a = (f.properties || {}).ADM_VALIDO || '-';
    l.bindPopup('<b>Administra:</b> ' + a);
  }
}).addTo(map);

// Departamentos
var departamentosLayer = L.geoJSON(null,{
  pane:'paneDepartamentos',
  style:function(){
    return { color:'#232323', weight: 1.2, fill:false, opacity: 0.6 };
  },
  onEachFeature:function(f,l){
    l.bindPopup('<b>Departamento:</b> ' + ((f.properties||{}).NOMBDEP || '-'));
  }
}).addTo(map);

// RVN
var rvnLayer = L.geoJSON(null,{
  pane:'paneRVN',
  style:function(){
    return { color:'#bdbdbd', weight: 1.4, opacity: 0.75 };
  },
  onEachFeature:function(f,l){
    l.bindPopup('<b>Código de ruta:</b> ' + ((f.properties||{}).cCodRuta || '-'));
  }
}).addTo(map);

// Tramos críticos (apagado por defecto)
var tramosLayer = L.geoJSON(null,{
  pane:'paneTramos',
  style:function(){
    return { color:'#f4ae18', weight: 5, opacity: 0.9 };
  },
  onEachFeature:function(f,l){
    l.bindPopup('<b>Tramo crítico</b><br><b>DGL:</b> ' + ((f.properties||{}).DGL || '-'));
  }
});
// (NO addTo(map) para que inicie OFF)

// Clusters (se crea luego del fetch porque calcula totales)
var clustersLayer = L.geoJSON(null, { pane:'paneClusters' }).addTo(map);

//////////////////////////////////////////////////
// FETCH + CARGA DE DATOS
//////////////////////////////////////////////////

function mustOk(r, name){
  if (!r.ok) throw new Error('No se pudo cargar: ' + name + ' (HTTP ' + r.status + ')');
  return r;
}

// 1) Concesiones + leyenda desplegable (se arma desde el GeoJSON)
fetch('data/concesiones.geojson')
  .then(r => mustOk(r, 'concesiones.geojson'))
  .then(r => r.json())
  .then(geojson => {

    concesionesLayer.addData(geojson);

    // Construir listado único de administradores con sus colores
    var admins = {};
    geojson.features.forEach(f => {
      var a = f.properties?.ADM_VALIDO || 'No especificado';
      admins[a] = colorByAdmin(a);
    });

    // Leyenda desplegable
    var legendAdmin = L.control({ position: 'topright' });
    legendAdmin.onAdd = function () {
      var div = L.DomUtil.create('div', 'legend');

      var title = L.DomUtil.create('div', 'legend-title', div);
      title.innerHTML = 'Red Vial Nacional – Concesiones ⬇';

      var body = L.DomUtil.create('div', 'legend-body', div);

      Object.keys(admins).sort().forEach(a => {
        var row = L.DomUtil.create('div', 'legend-row', body);
        var sw = L.DomUtil.create('span', 'swatch', row);
        sw.style.background = admins[a];
        row.appendChild(document.createTextNode(a));
      });

      // Colapsar por defecto en móvil
      if (window.innerWidth < 768) body.style.display = 'none';

      // Toggle
      L.DomEvent.disableClickPropagation(div);
      title.onclick = () => {
        body.style.display = (body.style.display === 'none') ? 'block' : 'none';
      };

      return div;
    };
    legendAdmin.addTo(map);
  })
  .catch(e => alert(e.message));

// 2) Departamentos
fetch('data/departamentos.geojson')
  .then(r => mustOk(r, 'departamentos.geojson'))
  .then(r => r.json())
  .then(j => departamentosLayer.addData(j))
  .catch(e => alert(e.message));

// 3) RVN
fetch('data/rvn.geojson')
  .then(r => mustOk(r, 'rvn.geojson'))
  .then(r => r.json())
  .then(j => rvnLayer.addData(j))
  .catch(e => alert(e.message));

// 4) Clusters (sumar Fallecidos por CLUSTER_ID y colorear)
var clusterTotals = {};
fetch('data/clusters.geojson')
  .then(r => mustOk(r, 'clusters.geojson'))
  .then(r => r.json())
  .then(j => {

    j.features.forEach(f => {
      var p = f.properties || {};
      var cid = p.CLUSTER_ID;
      var v = Number(p.Fallecidos || 0);
      clusterTotals[cid] = (clusterTotals[cid] || 0) + v;
    });

    clustersLayer = L.geoJSON(j,{
      pane:'paneClusters',
      pointToLayer: function (f, latlng) {
        var total = clusterTotals[f.properties.CLUSTER_ID] || 0;
        return L.circleMarker(latlng,{
          radius: 6,
          fillColor: colorByFallecidos(total),
          color: '#111',
          weight: 1,
          fillOpacity: 0.75
        });
      },
      onEachFeature: function (f, layer) {
        var cid = f.properties.CLUSTER_ID;
        layer.bindPopup(
          '<b>Cluster:</b> ' + cid +
          '<br><b>Fallecidos (cluster):</b> ' + (clusterTotals[cid] || 0)
        );
      }
    }).addTo(map);

    try { map.fitBounds(clustersLayer.getBounds(), { padding:[20,20] }); } catch(e){}
  })
  .catch(e => alert(e.message));

// 5) Tramos críticos (cargar, pero queda OFF hasta que el usuario lo active)
fetch('data/tramos-siniestros.geojson')
  .then(r => mustOk(r, 'tramos-siniestros.geojson'))
  .then(r => r.json())
  .then(j => tramosLayer.addData(j))
  .catch(e => alert(e.message));

//////////////////////////////////////////////////
// CONTROL DE CAPAS
//////////////////////////////////////////////////
L.control.layers(null,{
  'Concesiones': concesionesLayer,
  'Clusters – Fallecidos': clustersLayer,
  'Tramos críticos (DGL)': tramosLayer,
  'Red Vial Nacional': rvnLayer,
  'Departamentos': departamentosLayer
},{ collapsed:false }).addTo(map);

//////////////////////////////////////////////////
// LEYENDA CLUSTERS
//////////////////////////////////////////////////
var legendClusters = L.control({ position:'bottomright' });
legendClusters.onAdd = function(){
  var d = L.DomUtil.create('div','legend');
  d.innerHTML =
    '<div class="legend-title" style="cursor:default">Fallecidos por clúster</div>'+
    '<div class="legend-row"><span class="swatch" style="background:#fee5d9"></span>1–5</div>'+
    '<div class="legend-row"><span class="swatch" style="background:#fb6a4a"></span>6–10</div>'+
    '<div class="legend-row"><span class="swatch" style="background:#de2d26"></span>11–15</div>'+
    '<div class="legend-row"><span class="swatch" style="background:#a50f15"></span>16–20</div>'+
    '<div class="legend-row"><span class="swatch" style="background:#67000d"></span>≥21</div>';
  return d;
};
legendClusters.addTo(map);

// Leyenda tramos (simple)
var legendTramos = L.control({ position:'bottomleft' });
legendTramos.onAdd = function(){
  var d = L.DomUtil.create('div','legend');
  d.innerHTML =
    '<div class="legend-title" style="cursor:default">Tramos críticos</div>'+
    '<div class="legend-row"><span class="swatch" style="background:#f4ae18"></span>DGL (activable)</div>';
  return d;
};
legendTramos.addTo(map);

</script>
</body>
</html>
