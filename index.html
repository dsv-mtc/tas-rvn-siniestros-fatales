<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mapa interactivo – Siniestros fatales RVN</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { height:100%; margin:0; }
#map { height:100vh; width:100%; }

.legend{
  background:rgba(255,255,255,0.95);
  padding:10px 12px;
  border-radius:8px;
  box-shadow:0 2px 10px rgba(0,0,0,0.15);
  font:12px/1.35 system-ui, Arial;
}
.legend-title{ font-weight:700; margin-bottom:6px; }
.legend-row{ display:flex; align-items:center; gap:8px; margin:4px 0; }
.swatch{
  width:14px; height:14px;
  border-radius:3px;
  border:1px solid rgba(0,0,0,0.25);
}

.coord-box input{
  width:130px;
  padding:6px;
  margin-bottom:4px;
}
.coord-box button{
  padding:6px 10px;
  cursor:pointer;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>

//////////////////////////////////////////////////
// MAPA BASE
//////////////////////////////////////////////////
var map = L.map('map').setView([-9.2, -75.0], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

//////////////////////////////////////////////////
// BUSCADOR POR COORDENADAS
//////////////////////////////////////////////////
var coordMarker = null;

var coordControl = L.control({ position: 'topleft' });
coordControl.onAdd = function () {
  var div = L.DomUtil.create('div', 'legend coord-box');
  div.innerHTML =
    '<div class="legend-title">Ir a coordenadas</div>' +
    '<input id="latInput" placeholder="Lat (-12.0464)"><br>' +
    '<input id="lonInput" placeholder="Lon (-77.0428)"><br>' +
    '<button id="goBtn">Ir</button>';

  L.DomEvent.disableClickPropagation(div);
  return div;
};
coordControl.addTo(map);

setTimeout(function () {
  document.getElementById('goBtn').onclick = function () {
    var lat = parseFloat(document.getElementById('latInput').value.replace(',', '.'));
    var lon = parseFloat(document.getElementById('lonInput').value.replace(',', '.'));

    if (isNaN(lat) || isNaN(lon)) {
      alert('Ingrese coordenadas válidas');
      return;
    }
    map.setView([lat, lon], 16);
    if (coordMarker) map.removeLayer(coordMarker);
    coordMarker = L.marker([lat, lon]).addTo(map)
      .bindPopup('Lat: ' + lat + '<br>Lon: ' + lon)
      .openPopup();
  };
}, 0);

//////////////////////////////////////////////////
// FUNCIONES DE COLOR
//////////////////////////////////////////////////
function colorByFallecidos(v){
  if (v >= 21) return '#67000d';
  if (v >= 16) return '#a50f15';
  if (v >= 11) return '#de2d26';
  if (v >= 6)  return '#fb6a4a';
  if (v >= 1)  return '#fee5d9';
  return '#cccccc';
}

var adminColorMap = {};
var adminColors = [
  '#1f78b4','#33a02c','#e31a1c','#ff7f00','#6a3d9a',
  '#a6cee3','#b2df8a','#fb9a99','#fdbf6f','#cab2d6',
  '#8dd3c7','#ffffb3','#bebada','#fb8072','#80b1d3',
  '#fdb462','#b3de69','#fccde5','#d9d9d9','#bc80bd',
  '#ccebc5','#ffed6f','#66c2a5','#fc8d62','#8da0cb'
];

function colorByAdmin(a){
  if (!adminColorMap[a]) {
    var keys = Object.keys(adminColorMap).sort();
    adminColorMap[a] = adminColors[keys.length % adminColors.length];
  }
  return adminColorMap[a];
}

//////////////////////////////////////////////////
// 1. CONCESIONES (BASE + LEYENDA)
//////////////////////////////////////////////////
var concesionesLayer = L.geoJSON(null, {
  style: function (f) {
    var a = (f.properties || {}).ADM_VALIDO || 'No especificado';
    return { color: colorByAdmin(a), weight: 3, opacity: 0.7 };
  },
  onEachFeature: function (f, layer) {
    var a = (f.properties || {}).ADM_VALIDO || '-';
    layer.bindPopup('<b>Administra:</b> ' + a);
  }
}).addTo(map);

fetch('data/concesiones.geojson')
  .then(r => r.json())
  .then(j => {
    concesionesLayer.addData(j);

    // Leyenda concesiones
    var legendAdmin = L.control({ position: 'topright' });
    legendAdmin.onAdd = function () {
      var div = L.DomUtil.create('div', 'legend');
      var html = '<div class="legend-title">Red Vial Nacional - Concesiones</div>';
      Object.keys(adminColorMap).sort().forEach(function (k) {
        html += '<div class="legend-row">' +
                '<span class="swatch" style="background:' + adminColorMap[k] + '"></span>' +
                k + '</div>';
      });
      div.innerHTML = html;
      return div;
    };
    legendAdmin.addTo(map);
  });

//////////////////////////////////////////////////
// 2. DEPARTAMENTOS (BORDE)
//////////////////////////////////////////////////
var departamentosLayer = L.geoJSON(null, {
  style: function () {
    return {
      color: '#444444',
      weight: 1.5,
      fill: false,
      opacity: 0.9
    };
  },
  onEachFeature: function (f, layer) {
    layer.bindPopup('<b>Departamento:</b> ' + ((f.properties || {}).NOMBDEP || '-'));
  }
}).addTo(map);

fetch('data/departamentos.geojson')
  .then(r => r.json())
  .then(j => departamentosLayer.addData(j));

//////////////////////////////////////////////////
// 3. CLUSTERS (PUNTOS – FALLECIDOS)
//////////////////////////////////////////////////
var clusterTotals = {};

fetch('data/clusters.geojson')
  .then(r => r.json())
  .then(j => {

    j.features.forEach(function (f) {
      var p = f.properties || {};
      var cid = p.CLUSTER_ID;
      var v = Number(p.Fallecidos || 0);
      if (!clusterTotals[cid]) clusterTotals[cid] = 0;
      clusterTotals[cid] += v;
    });

    var clustersLayer = L.geoJSON(j, {
      pointToLayer: function (f, latlng) {
        var total = clusterTotals[f.properties.CLUSTER_ID] || 0;
        return L.circleMarker(latlng, {
          radius: 6,
          fillColor: colorByFallecidos(total),
          color: '#111',
          weight: 1,
          fillOpacity: 0.75
        });
      },
      onEachFeature: function (f, layer) {
        var p = f.properties || {};
        layer.bindPopup(
          '<b>Cluster:</b> ' + p.CLUSTER_ID + '<br>' +
          '<b>Fallecidos (cluster):</b> ' + clusterTotals[p.CLUSTER_ID]
        );
      }
    }).addTo(map);

    map.fitBounds(clustersLayer.getBounds(), { padding: [20,20] });

    //////////////////////////////////////////////////
    // 4. TRAMOS DE ALTA SINIESTRALIDAD (OCRE, OFF)
    //////////////////////////////////////////////////
    var tramosLayer = L.geoJSON(null, {
      style: function () {
        return {
          color: '#f4ae18',
          weight: 5,
          opacity: 0.9
        };
      },
      onEachFeature: function (f, layer) {
        layer.bindPopup(
          '<b>Tramo crítico</b><br>' +
          '<b>DGL:</b> ' + ((f.properties || {}).DGL || '-')
        );
      }
    });

    fetch('data/tramos-siniestros.geojson')
      .then(r => r.json())
      .then(j2 => tramosLayer.addData(j2));

    //////////////////////////////////////////////////
    // 5. CONTROL DE CAPAS
    //////////////////////////////////////////////////
    L.control.layers(null, {
      'Concesiones': concesionesLayer,
      'Departamentos': departamentosLayer,
      'Clusters – Fallecidos': clustersLayer,
      'Tramos críticos (DGL)': tramosLayer
    }, {
      collapsed: false
    }).addTo(map);

  });

//////////////////////////////////////////////////
// LEYENDAS
//////////////////////////////////////////////////
var legendClusters = L.control({ position: 'bottomright' });
legendClusters.onAdd = function () {
  var div = L.DomUtil.create('div', 'legend');
  div.innerHTML =
    '<div class="legend-title">Fallecidos por clúster</div>' +
    '<div class="legend-row"><span class="swatch" style="background:#fee5d9"></span>1–5</div>' +
    '<div class="legend-row"><span class="swatch" style="background:#fb6a4a"></span>6–10</div>' +
    '<div class="legend-row"><span class="swatch" style="background:#de2d26"></span>11–15</div>' +
    '<div class="legend-row"><span class="swatch" style="background:#a50f15"></span>16–20</div>' +
    '<div class="legend-row"><span class="swatch" style="background:#67000d"></span>≥21</div>';
  return div;
};
legendClusters.addTo(map);

var legendTramos = L.control({ position: 'bottomleft' });
legendTramos.onAdd = function () {
  var div = L.DomUtil.create('div', 'legend');
  div.innerHTML =
    '<div class="legend-title">Tramos críticos</div>' +
    '<div class="legend-row"><span class="swatch" style="background:#f4ae18"></span>DGL (activable)</div>';
  return div;
};
legendTramos.addTo(map);

</script>
</body>
</html>