<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mapa interactivo ‚Äì Siniestros fatales RVN</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.polylinemeasure/Leaflet.PolylineMeasure.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css">

<style>
html, body { height:100%; margin:0; }
#map { height:100vh; width:100%; }

/* ================= LEYENDA ================= */
.legend{
  background:rgba(255,255,255,0.95);
  padding:0;
  border-radius:8px;
  box-shadow:0 2px 10px rgba(0,0,0,0.15);
  font:12px/1.35 system-ui, Arial;
  width:260px;
  overflow:hidden;
}

.legend-header{
  padding:10px 12px;
  font-weight:700;
  background:#f4f4f4;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.legend-body{
  padding:10px 12px;
  max-height:45vh;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}

.legend-title{
  font-weight:700;
  margin:10px 0 6px;
  border-bottom:1px solid #ddd;
}

.legend-row{
  display:flex;
  align-items:center;
  gap:8px;
  margin:4px 0;
}

.swatch{
  width:14px;
  height:14px;
  border-radius:3px;
  border:1px solid rgba(0,0,0,0.25);
}
.swatch.line{ height:4px; border:none; }
.swatch.dashed{
  background:none;
  border:2px dashed #333;
  height:10px;
}
/* Estado colapsado: oculta el cuerpo */
.legend.collapsed .legend-body{
  display: none;
}

/* Indicador visual */
.legend-header span{
  font-size:14px;
  opacity:0.7;
}

@media (max-width: 768px){

  /* Leyenda m√°s compacta */
  .legend{
    width:90vw;
    max-width:300px;
     position:relative;
  }

  .legend-header{
    padding:8px 10px;
    font-size:12px;
  }

   .legend-title{
    margin:6px 0 4px;
    font-size:11px;
  }

  .legend-row{
    margin:2px 0;
    gap:6px;
  }

  .swatch{
    width:12px;
    height:12px;
  }

  /* Que inicie colapsada (clave en m√≥vil) */
  .legend{
    max-height:none;
  }
}

/* Escala y minimap visibles */
.leaflet-control-scale{
  z-index:1100 !important;
}
.leaflet-control-minimap{
  z-index:1050 !important;
}

/* ===== FIX CONTROLES EN M√ìVIL ===== */

/* Escala siempre visible */
.leaflet-control-scale {
  z-index: 1100 !important;
}

/* MiniMap por debajo de la leyenda pero visible */
.leaflet-control-minimap {
  z-index: 1000 !important;
}

/* En m√≥vil, empujar controles hacia arriba */
@media (max-width: 768px){
  .leaflet-bottom.leaflet-right {
    bottom: 90px; /* deja espacio para la leyenda */
  }
  .leaflet-bottom.leaflet-left {
    bottom: 90px;
  }
}

/* ===== FIX CONTROLES EN M√ìVIL ===== */

/* Escala siempre visible */
.leaflet-control-scale{
  z-index: 1100 !important;
}

/* MiniMap visible pero debajo de la leyenda */
.leaflet-control-minimap{
  z-index: 1000 !important;
}

/* MiniMap m√°s peque√±o en celular */
@media (max-width: 768px){
  .minimap-mobile{
    transform: scale(0.85);
    transform-origin: bottom right;
  }

  /* Empujar controles hacia arriba para no chocar con la leyenda */
  .leaflet-bottom.leaflet-right,
  .leaflet-bottom.leaflet-left{
    bottom: 90px;
  }
}

</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.polylinemeasure/Leaflet.PolylineMeasure.js"></script>
<script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>
<script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
  
<script>
//////////////////////////////////////////////////
// MAPA BASE
//////////////////////////////////////////////////
var map = L.map('map').setView([-9.2, -75], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

// Bot√≥n Exportar Imagen
var exportImgControl = L.control({ position: 'topright' });
exportImgControl.onAdd = function () {
  var div = L.DomUtil.create('div', 'legend');
  div.style.padding = '6px';

  var btn = L.DomUtil.create('button', '', div);
  btn.innerHTML = 'üì∏ Exportar imagen';
  btn.style.cursor = 'pointer';
  btn.style.width = '100%';

  L.DomEvent.on(btn, 'click', function (e) {
    L.DomEvent.stopPropagation(e);

    leafletImage(map, function(err, canvas) {
      if (err) {
        alert('Error al exportar imagen');
        return;
      }
      var img = document.createElement('a');
      img.href = canvas.toDataURL('image/png');
      img.download = 'mapa_tramos_alta_siniestralidad.png';
      img.click();
    });
  });

  L.DomEvent.disableClickPropagation(div);
  return div;
};
exportImgControl.addTo(map);

//////////////////////////////////////////////////
// CONTROLES
//////////////////////////////////////////////////
L.control.polylineMeasure({
  position:'topleft',
  unit:'metres',
  tooltipTextFinish:'Doble clic para terminar'
}).addTo(map);

L.control.scale({
  position:'bottomright',
  metric:true,
  imperial:false
}).addTo(map);

new L.Control.MiniMap(
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
  {toggleDisplay:true, minimized:true}
).addTo(map);

// Ajustes espec√≠ficos para m√≥vil (MiniMap)
if (window.innerWidth < 768) {
  const mm = document.querySelector('.leaflet-control-minimap');
  if (mm) {
    mm.classList.add('minimap-mobile');
  }
}

//////////////////////////////////////////////////
// PANES
//////////////////////////////////////////////////
map.createPane('paneConcesiones');   map.getPane('paneConcesiones').style.zIndex = 200;
map.createPane('paneDepartamentos'); map.getPane('paneDepartamentos').style.zIndex = 300;
map.createPane('paneRVN');           map.getPane('paneRVN').style.zIndex = 350;
map.createPane('paneClusters');      map.getPane('paneClusters').style.zIndex = 450;
map.createPane('paneTramos');        map.getPane('paneTramos').style.zIndex = 500;

//////////////////////////////////////////////////
// COLORES
//////////////////////////////////////////////////
function colorByFallecidos(v){
  if(v>=21) return '#67000d';
  if(v>=16) return '#a50f15';
  if(v>=11) return '#de2d26';
  if(v>=6)  return '#fb6a4a';
  if(v>=1)  return '#fee5d9';
  return '#ccc';
}

var adminColorMap={}, adminColors=[
 '#1f78b4','#33a02c','#e31a1c','#ff7f00','#6a3d9a',
 '#a6cee3','#b2df8a','#fb9a99','#fdbf6f','#cab2d6'
];
function colorByAdmin(a){
  if(!adminColorMap[a]){
    adminColorMap[a]=adminColors[Object.keys(adminColorMap).length % adminColors.length];
  }
  return adminColorMap[a];
}

//////////////////////////////////////////////////
// CONCESIONES
//////////////////////////////////////////////////
var concesionesLayer = L.geoJSON(null,{
  pane:'paneConcesiones',
  style:f=>({
    color:colorByAdmin(f.properties.ADM_VALIDO||'N/D'),
    weight:4,
    opacity:0.7
  }),
  onEachFeature:(f,l)=>{
    l.bindTooltip('<b>Concesi√≥n:</b> '+(f.properties.ADM_VALIDO||'-'),{sticky:true});
  }
}).addTo(map);

fetch('data/concesiones.geojson')
  .then(r=>r.json())
  .then(j=>{
    concesionesLayer.addData(j);
    construirLeyenda();
  });

//////////////////////////////////////////////////
// DEPARTAMENTOS
//////////////////////////////////////////////////
var departamentosLayer = L.geoJSON(null,{
  pane:'paneDepartamentos',
  style:{ color:'#222', weight:1.2, fill:false, dashArray:'4 4' },
  onEachFeature:(f,l)=>{
    l.bindTooltip('<b>Departamento:</b> '+(f.properties.NOMBDEP||'-'),{sticky:true});
  }
}).addTo(map);
fetch('data/departamentos.geojson').then(r=>r.json()).then(j=>departamentosLayer.addData(j));

//////////////////////////////////////////////////
// RVN
//////////////////////////////////////////////////
var rvnLayer = L.geoJSON(null,{
  pane:'paneRVN',
  style:{ color:'#8d6e63', weight:2 },
  onEachFeature:(f,l)=>{
    l.bindTooltip('<b>Ruta:</b> '+(f.properties.cCodRuta||'-'),{sticky:true});
  }
}).addTo(map);
fetch('data/rvn.geojson').then(r=>r.json()).then(j=>rvnLayer.addData(j));

//////////////////////////////////////////////////
// CLUSTERS
//////////////////////////////////////////////////
var clusterTotals = {};
var clusterCounts = {};                 // ‚Üê CAMBIO
var clustersLayer = L.geoJSON(null,{pane:'paneClusters'}).addTo(map);

fetch('data/clusters.geojson').then(r=>r.json()).then(j=>{
  j.features.forEach(f=>{
    var id = f.properties.CLUSTER_ID;
    clusterTotals[id] = (clusterTotals[id]||0) + Number(f.properties.Fallecidos||0);
    clusterCounts[id] = (clusterCounts[id]||0) + 1;   // ‚Üê CAMBIO
  });

  clustersLayer.options.pointToLayer = (f,ll)=>L.circleMarker(ll,{
    radius:6,
    fillColor:colorByFallecidos(clusterTotals[f.properties.CLUSTER_ID]),
    color:'#111',
    fillOpacity:0.75
  });

  clustersLayer.options.onEachFeature = (f,l)=>{
    var id = f.properties.CLUSTER_ID;
    l.bindTooltip(
      '<b>Cluster:</b> '+id+
      '<br><b>Siniestros:</b> '+clusterCounts[id]+      // ‚Üê CAMBIO
      '<br><b>Fallecidos:</b> '+clusterTotals[id],
      {sticky:true}
    );
  };

  clustersLayer.addData(j);
  map.fitBounds(clustersLayer.getBounds(),{padding:[20,20]});
});

//////////////////////////////////////////////////
// TRAMOS
//////////////////////////////////////////////////
var tramosLayer = L.geoJSON(null, {
  pane: 'paneTramos',
  style: { color: '#f4ae18', weight: 5 },
  onEachFeature: (f, l) => {
    var m = Number(f.properties.Longitud_m || 0).toFixed(0);

    l.bindTooltip(
      '<b>Tramo Alta Siniestralidad</b><br>' +
      '<b>Cluster:</b> ' + (f.properties.CLUSTER_ID || '-') + '<br>' +
      '<b>Siniestros:</b> ' + (f.properties.Siniestros || '-') + '<br>' + // ‚Üê CAMBIO
      '<b>Fallecidos:</b> ' + (f.properties.Fallecidos || '-') + '<br>' + // ‚Üê CAMBIO
      '<b>Longitud:</b> ' + m + ' m',
      { sticky: true }
    );
  }
});

fetch('data/tramos-siniestros.geojson')
  .then(r => r.json())
  .then(j => tramosLayer.addData(j));

//////////////////////////////////////////////////
// CONTROL DE CAPAS (COLAPSABLE)
//////////////////////////////////////////////////
L.control.layers(null,{
  'Clusters ‚Äì Fallecidos':clustersLayer,
  'Tramos de Alta Siniestralidad':tramosLayer,
  'Concesiones':concesionesLayer,
  'Red Vial Nacional':rvnLayer,
  'Departamentos':departamentosLayer
},{collapsed:true}).addTo(map);

//////////////////////////////////////////////////
// LEYENDA UNIFICADA Y SEGURA
//////////////////////////////////////////////////
function isMobile(){ return window.innerWidth < 768; }
var legend = L.control({ position: isMobile() ? 'topright' : 'bottomleft' });

function construirLeyenda(){
  legend.onAdd = function(){
    var d = L.DomUtil.create('div','legend');
    
    var header = L.DomUtil.create('div','legend-header', d);
    header.innerHTML = 'LEYENDA <span>‚ò∞</span>';

    header.setAttribute('role','button');
    header.setAttribute('aria-label','Mostrar u ocultar leyenda');


    var body = L.DomUtil.create('div','legend-body', d);
    // Evitar que el scroll de la leyenda mueva el mapa (clave en celular)
    L.DomEvent.disableScrollPropagation(body);
    L.DomEvent.disableClickPropagation(d);

    body.innerHTML += `
      <div class="legend-title">Fallecidos por cl√∫ster</div>
      <div class="legend-row"><span class="swatch" style="background:#fee5d9"></span>1‚Äì5</div>
      <div class="legend-row"><span class="swatch" style="background:#fb6a4a"></span>6‚Äì10</div>
      <div class="legend-row"><span class="swatch" style="background:#de2d26"></span>11‚Äì15</div>
      <div class="legend-row"><span class="swatch" style="background:#a50f15"></span>16‚Äì20</div>
      <div class="legend-row"><span class="swatch" style="background:#67000d"></span>‚â•21</div>
      <div class="legend-title">Concesiones</div>
    `;

    Object.keys(adminColorMap).sort().forEach(a=>{
      body.innerHTML += `
        <div class="legend-row">
          <span class="swatch" style="background:${adminColorMap[a]}"></span>${a}
        </div>
      `;
    });

    body.innerHTML += `
      <div class="legend-title"> </div>
      <div class="legend-row"><span class="swatch line" style="background:#f4ae18"></span>Tramos Alta Siniestralidad</div>
      <div class="legend-row"><span class="swatch line" style="background:#8d6e63"></span>Red Vial Nacional</div>
      <div class="legend-row"><span class="swatch dashed"></span>Departamentos</div>
    `;

    L.DomEvent.on(header,'click',function(){
      d.classList.toggle('collapsed');
    });

    if (window.innerWidth < 768){
      d.classList.add('collapsed');
    }

    return d;
  };
  legend.addTo(map);
}
  
</script>
</body>
</html>
