<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mapa interactivo – Siniestros fatales RVN</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; }

    .legend {
      background: rgba(255,255,255,0.95);
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      font: 12px/1.35 system-ui, Segoe UI, Arial;
    }
    .legend-title { font-weight: 700; margin-bottom: 6px; }
    .legend-row { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .swatch { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.2); }

    .coord-box input {
      width: 135px;
      padding: 6px;
    }
    .coord-box button {
      padding: 6px 10px;
      cursor: pointer;
    }
  </style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // ================= MAPA BASE =================
  var map = L.map('map').setView([-9.2, -75.0], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // ================= COLORES SINIESTROS =================
  function colorBySiniestros(v) {
    if (v >= 20) return '#7f0000';
    if (v >= 15) return '#b30000';
    if (v >= 10) return '#e34a33';
    if (v >= 5)  return '#fc8d59';
    return '#fee8c8';
  }

  // ================= COLORES CONCESIONES =================
  var adminColorMap = {};
  var adminColors = [
    '#1f78b4','#33a02c','#e31a1c','#ff7f00','#6a3d9a',
    '#b15928','#a6cee3','#b2df8a','#fb9a99','#fdbf6f'
  ];

  function colorByAdmin(admin) {
    if (!adminColorMap[admin]) {
      var idx = Object.keys(adminColorMap).length % adminColors.length;
      adminColorMap[admin] = adminColors[idx];
    }
    return adminColorMap[admin];
  }

  // ================= CLUSTERS / SINIESTROS =================
  var clustersLayer = L.geoJSON(null, {
    pointToLayer: function (f, latlng) {
      var p = f.properties || {};
      var v = Number(p.Siniestros_Total || 0);

      return L.circleMarker(latlng, {
        radius: 6,
        fillColor: colorBySiniestros(v),
        color: '#111',
        weight: 1,
        opacity: 0.9,
        fillOpacity: 0.85
      });
    },
    style: function (f) {
      var p = f.properties || {};
      var v = Number(p.Siniestros_Total || 0);
      return { color: colorBySiniestros(v), weight: 5, opacity: 0.95 };
    },
    onEachFeature: function (f, layer) {
      var p = f.properties || {};
      layer.bindPopup(
        '<b>Cluster:</b> ' + (p.CLUSTER_ID || '-') + '<br>' +
        '<b>Tramo:</b> ' + (p.TRAMO || '-') + '<br>' +
        '<b>Ruta:</b> ' + (p.cCodRuta || '-') + '<br>' +
        '<b>Siniestros fatales:</b> ' + (p.Siniestros_Total || '-') + '<br>' +
        '<b>Fallecidos:</b> ' + (p.Fallecidos || '-') + '<br>' +
        '<b>Longitud (km):</b> ' + (p.Longitud_km || '-') + '<br>' +
        '<b>Administra:</b> ' + (p.ADM_VALIDO || '-')
      );
    }
  });

  fetch('data/clusters.geojson')
    .then(r => r.json())
    .then(j => {
      clustersLayer.addData(j);
      clustersLayer.addTo(map);
      try { map.fitBounds(clustersLayer.getBounds(), { padding: [20,20] }); } catch(e){}
    });

  // ================= CONCESIONES =================
  var concesionesLayer = L.geoJSON(null, {
    style: function (f) {
      var admin = (f.properties || {}).ADM_VALIDO || 'No especificado';
      return { color: colorByAdmin(admin), weight: 3, opacity: 0.85 };
    },
    onEachFeature: function (f, layer) {
      var admin = (f.properties || {}).ADM_VALIDO || 'No especificado';
      layer.bindPopup('<b>Administra:</b> ' + admin);
    }
  });

  fetch('data/concesiones.geojson')
    .then(r => r.json())
    .then(j => {
      concesionesLayer.addData(j);
      concesionesLayer.addTo(map);

      // Leyenda concesiones
      var legendAdmin = L.control({ position: 'bottomleft' });
      legendAdmin.onAdd = function () {
        var div = L.DomUtil.create('div', 'legend');
        var html = '<div class="legend-title">Concesiones (Administra)</div>';

        Object.keys(adminColorMap).sort().forEach(function (k) {
          html += '<div class="legend-row">' +
                  '<span class="swatch" style="background:' + adminColorMap[k] + '"></span>' +
                  k + '</div>';
        });

        div.innerHTML = html;
        return div;
      };
      legendAdmin.addTo(map);
    });

  // ================= CONTROL DE CAPAS =================
  L.control.layers(null, {
    'Siniestros fatales (clusters)': clustersLayer,
    'Concesiones (Administra)': concesionesLayer
  }, { collapsed: false }).addTo(map);

  // ================= LEYENDA SINIESTROS =================
  var legendS = L.control({ position: 'bottomright' });
  legendS.onAdd = function () {
    var div = L.DomUtil.create('div', 'legend');
    div.innerHTML =
      '<div class="legend-title">Número de siniestros fatales</div>' +
      '<div class="legend-row"><span class="swatch" style="background:#fee8c8"></span> 1 – 4</div>' +
      '<div class="legend-row"><span class="swatch" style="background:#fc8d59"></span> 5 – 9</div>' +
      '<div class="legend-row"><span class="swatch" style="background:#e34a33"></span> 10 – 14</div>' +
      '<div class="legend-row"><span class="swatch" style="background:#b30000"></span> 15 – 19</div>' +
      '<div class="legend-row"><span class="swatch" style="background:#7f0000"></span> ≥ 20</div>';
    return div;
  };
  legendS.addTo(map);

  // ================= BUSCADOR POR COORDENADAS =================
  var coordMarker = null;

  var coordControl = L.control({ position: 'topleft' });
  coordControl.onAdd = function () {
    var div = L.DomUtil.create('div', 'legend coord-box');
    div.innerHTML =
      '<div class="legend-title">Ir a coordenadas</div>' +
      '<input id="latInput" placeholder="Lat (ej: -12.0464)"><br>' +
      '<input id="lonInput" placeholder="Lon (ej: -77.0428)"><br>' +
      '<button id="goBtn">Ir</button>';

    L.DomEvent.disableClickPropagation(div);
    return div;
  };
  coordControl.addTo(map);

  setTimeout(function () {
    document.getElementById('goBtn').onclick = function () {
      var lat = parseFloat(document.getElementById('latInput').value.replace(',', '.'));
      var lon = parseFloat(document.getElementById('lonInput').value.replace(',', '.'));

      if (isNaN(lat) || isNaN(lon)) {
        alert('Ingrese coordenadas válidas');
        return;
      }

      map.setView([lat, lon], 16);
      if (coordMarker) map.removeLayer(coordMarker);
      coordMarker = L.marker([lat, lon]).addTo(map)
        .bindPopup('Lat: ' + lat + '<br>Lon: ' + lon)
        .openPopup();
    };
  }, 0);

</script>
</body>
</html>