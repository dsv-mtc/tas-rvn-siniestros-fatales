<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mapa interactivo – Tramos de Alta Siniestralidad RVN</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<!-- Plugins -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.polylinemeasure/Leaflet.PolylineMeasure.css"/>

<style>
html, body { height:100%; margin:0; }
#map { height:100vh; width:100%; }

.legend{
  background:rgba(255,255,255,0.95);
  padding:10px 12px;
  border-radius:8px;
  box-shadow:0 2px 10px rgba(0,0,0,0.15);
  font:12px/1.35 system-ui, Arial;
}
.legend-title{ font-weight:700; margin-bottom:6px; }
.legend-row{ display:flex; align-items:center; gap:8px; margin:4px 0; }
.swatch{
  width:14px; height:14px;
  border-radius:3px;
  border:1px solid rgba(0,0,0,0.25);
}
.legend-body{ max-height:240px; overflow-y:auto; }

.tool-box input, .coord-box input{
  width:160px;
  padding:6px;
  margin:4px 0;
}
.tool-box button, .coord-box button{
  width:100%;
  padding:6px;
  cursor:pointer;
}

@media (max-width:768px){
  .legend{ max-height:40vh; overflow-y:auto; }
}
</style>
</head>

<body>
<div id="map"></div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>
<script src="https://unpkg.com/leaflet.polylinemeasure/Leaflet.PolylineMeasure.js"></script>
<script src="https://unpkg.com/leaflet-simple-map-screenshoter/dist/leaflet-simple-map-screenshoter.js"></script>

<script>
/* ==================================================
   HELPERS
================================================== */
function n(x){ var v=Number(x); return isNaN(v)?0:v; }
function fmtInt(x){ return (x||0).toLocaleString('es-PE'); }
function mustOk(r,n){ if(!r.ok) throw new Error('Error '+n); return r; }

/* ==================================================
   MAPA BASE
================================================== */
var map = L.map('map').setView([-9.2,-75],6);

var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap'
}).addTo(map);

L.control.scale({metric:true, imperial:false}).addTo(map);

new L.Control.MiniMap(osm,{
  minimized:true,
  toggleDisplay:true
}).addTo(map);

L.control.polylineMeasure({
  position:'topleft',
  unit:'metres'
}).addTo(map);

/* ==================================================
   SCREENSHOT
================================================== */
L.simpleMapScreenshoter({
  position:'topleft',
  screenName:'Mapa_RVN_Alta_Siniestralidad'
}).addTo(map);

/* ==================================================
   PANES
================================================== */
['Concesiones','Departamentos','RVN','Clusters','Tramos'].forEach(function(p,i){
  map.createPane('pane'+p);
  map.getPane('pane'+p).style.zIndex = 200+i*50;
});

/* ==================================================
   COLORES
================================================== */
function colorByFallecidos(v){
  if(v>=21) return '#67000d';
  if(v>=16) return '#a50f15';
  if(v>=11) return '#de2d26';
  if(v>=6)  return '#fb6a4a';
  if(v>=1)  return '#fee5d9';
  return '#ccc';
}

/* ==================================================
   CAPAS (NO se redefinen)
================================================== */
var clustersLayer = L.geoJSON(null,{pane:'paneClusters'}).addTo(map);
var tramosLayer   = L.geoJSON(null,{pane:'paneTramos'});
var concesionesLayer = L.geoJSON(null,{pane:'paneConcesiones'}).addTo(map);
var departamentosLayer = L.geoJSON(null,{pane:'paneDepartamentos'}).addTo(map);
var rvnLayer = L.geoJSON(null,{pane:'paneRVN'}).addTo(map);

/* ==================================================
   CONTROL DE CAPAS
================================================== */
var layerControl = L.control.layers(null,{
  'Clusters (fallecidos)': clustersLayer,
  'Tramos críticos': tramosLayer,
  'Concesiones': concesionesLayer,
  'Departamentos': departamentosLayer,
  'Red Vial Nacional': rvnLayer
},{collapsed:false}).addTo(map);

/* ==================================================
   ÍNDICES PARA INTERACCIÓN
================================================== */
var clusterTotals={}, tramosIndex={}, clusterPoints={};

/* ==================================================
   TRAMOS
================================================== */
fetch('data/tramos-siniestros.geojson')
.then(r=>mustOk(r,'tramos')).then(r=>r.json())
.then(j=>{
  tramosLayer.clearLayers();
  L.geoJSON(j,{
    pane:'paneTramos',
    style:()=>({color:'#1f78b4',weight:5}),
    onEachFeature:function(f,l){
      var cid = f.properties.CLUSTER_ID ?? '-';
      if(!tramosIndex[cid]) tramosIndex[cid]=[];
      tramosIndex[cid].push(l);
      l.bindTooltip(
        '<b>Cluster:</b> '+cid+
        '<br><b>DGL:</b> '+(f.properties.DGL||'-'),
        {sticky:true}
      );
    }
  }).eachLayer(l=>tramosLayer.addLayer(l));
});

/* ==================================================
   CLUSTERS
================================================== */
fetch('data/clusters.geojson')
.then(r=>mustOk(r,'clusters')).then(r=>r.json())
.then(j=>{
  clusterTotals={};
  j.features.forEach(f=>{
    var cid=f.properties.CLUSTER_ID;
    clusterTotals[cid]=(clusterTotals[cid]||0)+n(f.properties.Fallecidos);
  });

  clustersLayer.clearLayers();
  L.geoJSON(j,{
    pane:'paneClusters',
    pointToLayer:(f,latlng)=>{
      var cid=f.properties.CLUSTER_ID;
      return L.circleMarker(latlng,{
        radius:6,
        fillColor:colorByFallecidos(clusterTotals[cid]),
        color:'#111',weight:1,fillOpacity:.8
      });
    },
    onEachFeature:function(f,l){
      var cid=f.properties.CLUSTER_ID;
      if(!clusterPoints[cid]) clusterPoints[cid]=[];
      clusterPoints[cid].push(l);

      l.bindTooltip(
        '<b>Cluster:</b> '+cid+
        '<br><b>Fallecidos:</b> '+fmtInt(clusterTotals[cid]),
        {sticky:true}
      );

      l.on('mouseover',()=>{
        (tramosIndex[cid]||[]).forEach(t=>{
          t.setStyle({color:'#08306b',weight:8});
        });
      });
      l.on('mouseout',()=>{
        (tramosIndex[cid]||[]).forEach(t=>{
          t.setStyle({color:'#1f78b4',weight:5});
        });
      });
    }
  }).eachLayer(l=>clustersLayer.addLayer(l));

  map.fitBounds(clustersLayer.getBounds(),{padding:[20,20]});
});
</script>
</body>
</html>

