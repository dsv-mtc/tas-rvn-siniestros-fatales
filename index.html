<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mapa interactivo â€“ Siniestros fatales RVN</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.polylinemeasure/Leaflet.PolylineMeasure.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css">

<style>
html, body { height:100%; margin:0; }
#map { height:100vh; width:100%; }

/* ================= LEYENDA ================= */
.legend{
  background:rgba(255,255,255,0.95);
  border-radius:8px;
  box-shadow:0 2px 10px rgba(0,0,0,0.15);
  font:12px/1.35 system-ui, Arial;
  width:260px;
  overflow:hidden;
}
.legend-header{
  padding:10px 12px;
  font-weight:700;
  background:#f4f4f4;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
}
.legend-body{
  padding:10px 12px;
  max-height:45vh;
  overflow:auto;
}
.legend.collapsed .legend-body{ display:none; }
.legend-title{
  font-weight:700;
  margin:10px 0 6px;
  border-bottom:1px solid #ddd;
}
.legend-row{
  display:flex;
  align-items:center;
  gap:8px;
  margin:4px 0;
}
.swatch{
  width:14px; height:14px;
  border-radius:3px;
  border:1px solid rgba(0,0,0,0.25);
}
.swatch.line{ height:4px; border:none; }
.swatch.dashed{
  background:none;
  border:2px dashed #333;
  height:10px;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.polylinemeasure/Leaflet.PolylineMeasure.js"></script>
<script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>

<script>
//////////////////////////////////////////////////
// MAPA BASE
//////////////////////////////////////////////////
var map = L.map('map').setView([-9.2, -75], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

//////////////////////////////////////////////////
// CONTROLES
//////////////////////////////////////////////////
L.control.polylineMeasure({
  position:'topleft',
  unit:'metres',
  tooltipTextFinish:'Doble clic para terminar'
}).addTo(map);

L.control.scale({ position:'bottomright', metric:true, imperial:false }).addTo(map);

new L.Control.MiniMap(
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
  {toggleDisplay:true, minimized:true}
).addTo(map);

//////////////////////////////////////////////////
// UBICACIÃ“N ACTUAL
//////////////////////////////////////////////////
var userMarker=null, userCircle=null;
var locateControl=L.control({position:'topleft'});
locateControl.onAdd=function(){
  var d=L.DomUtil.create('div','leaflet-bar leaflet-control');
  d.innerHTML='ðŸ“';
  d.style.background='#fff';
  d.style.width='34px';
  d.style.height='34px';
  d.style.lineHeight='34px';
  d.style.textAlign='center';
  d.style.cursor='pointer';
  L.DomEvent.on(d,'click',e=>{
    L.DomEvent.stop(e);
    map.locate({setView:true,maxZoom:16});
  });
  return d;
};
locateControl.addTo(map);

map.on('locationfound',e=>{
  if(userMarker) map.removeLayer(userMarker);
  if(userCircle) map.removeLayer(userCircle);

  userMarker=L.circleMarker(e.latlng,{
    radius:6, fillColor:'#1976d2',
    color:'#fff', weight:2, fillOpacity:0.9
  }).addTo(map);

  userCircle=L.circle(e.latlng,{
    radius:e.accuracy, color:'#1976d2',
    opacity:0.4, fillOpacity:0.1
  }).addTo(map);

  userMarker.bindTooltip(
    'Tu ubicaciÃ³n<br>Â±'+Math.round(e.accuracy)+' m',{sticky:true});
});

//////////////////////////////////////////////////
// PANES
//////////////////////////////////////////////////
map.createPane('paneConcesiones').style.zIndex=200;
map.createPane('paneDepartamentos').style.zIndex=300;
map.createPane('paneRVN').style.zIndex=350;
map.createPane('paneClusters').style.zIndex=450;
map.createPane('paneTramos').style.zIndex=500;

//////////////////////////////////////////////////
// COLORES
//////////////////////////////////////////////////
function colorByFallecidos(v){
  if(v>=21) return '#67000d';
  if(v>=16) return '#a50f15';
  if(v>=11) return '#de2d26';
  if(v>=6) return '#fb6a4a';
  if(v>=1) return '#fee5d9';
  return '#ccc';
}

var adminColorMap={}, adminColors=[
 '#1f78b4','#33a02c','#e31a1c','#ff7f00','#6a3d9a',
 '#a6cee3','#b2df8a','#fb9a99','#fdbf6f','#cab2d6'
];
function colorByAdmin(a){
  if(!adminColorMap[a])
    adminColorMap[a]=adminColors[Object.keys(adminColorMap).length%adminColors.length];
  return adminColorMap[a];
}

//////////////////////////////////////////////////
// CONCESIONES
//////////////////////////////////////////////////
var concesionesLayer=L.geoJSON(null,{
  pane:'paneConcesiones',
  style:f=>({color:colorByAdmin(f.properties.ADM_VALIDO||'N/D'),weight:4}),
  onEachFeature:(f,l)=>l.bindTooltip(
    '<b>ConcesiÃ³n:</b> '+(f.properties.ADM_VALIDO||'-'),{sticky:true})
}).addTo(map);

fetch('data/concesiones.geojson').then(r=>r.json()).then(j=>{
  concesionesLayer.addData(j);
  construirLeyenda();
});

//////////////////////////////////////////////////
// DEPARTAMENTOS
//////////////////////////////////////////////////
var departamentosLayer=L.geoJSON(null,{
  pane:'paneDepartamentos',
  style:{color:'#222',weight:1.2,fill:false,dashArray:'4 4'},
  onEachFeature:(f,l)=>l.bindTooltip(
    '<b>Departamento:</b> '+(f.properties.NOMBDEP||'-'),{sticky:true})
}).addTo(map);
fetch('data/departamentos.geojson').then(r=>r.json()).then(j=>departamentosLayer.addData(j));

//////////////////////////////////////////////////
// RVN
//////////////////////////////////////////////////
var rvnLayer=L.geoJSON(null,{
  pane:'paneRVN',
  style:{color:'#8d6e63',weight:2},
  onEachFeature:(f,l)=>l.bindTooltip(
    '<b>Ruta:</b> '+(f.properties.cCodRuta||'-'),{sticky:true})
}).addTo(map);
fetch('data/rvn.geojson').then(r=>r.json()).then(j=>rvnLayer.addData(j));

//////////////////////////////////////////////////
// CLUSTERS
//////////////////////////////////////////////////
var clusterTotals={}, clustersLayer=L.geoJSON(null,{pane:'paneClusters'}).addTo(map);
fetch('data/clusters.geojson').then(r=>r.json()).then(j=>{
  j.features.forEach(f=>{
    var id=f.properties.CLUSTER_ID;
    clusterTotals[id]=(clusterTotals[id]||0)+Number(f.properties.Fallecidos||0);
  });

  clustersLayer.options.pointToLayer=(f,ll)=>L.circleMarker(ll,{
    radius:6,
    fillColor:colorByFallecidos(clusterTotals[f.properties.CLUSTER_ID]),
    color:'#111',fillOpacity:0.75
  });

  clustersLayer.options.onEachFeature=(f,l)=>l.bindTooltip(
    '<b>Cluster:</b> '+f.properties.CLUSTER_ID+
    '<br><b>Fallecidos:</b> '+clusterTotals[f.properties.CLUSTER_ID],
    {sticky:true}
  );

  clustersLayer.addData(j);
  map.fitBounds(clustersLayer.getBounds(),{padding:[20,20]});
});

//////////////////////////////////////////////////
// TRAMOS (CORREGIDO)
//////////////////////////////////////////////////
var tramosLayer=L.geoJSON(null,{
  pane:'paneTramos',
  style:{color:'#f4ae18',weight:5},
  onEachFeature:(f,l)=>{
    var m=Number(f.properties.Longitud_m||0).toFixed(0);
    l.bindTooltip(
      '<b>Tramo Alta Siniestralidad</b><br>'+
      '<b>Cluster:</b> '+(f.properties.CLUSTER_ID||'-')+'<br>'+
      '<b>Longitud:</b> '+m+' m',
      {sticky:true}
    );
  }
});
fetch('data/tramos-siniestros.geojson').then(r=>r.json()).then(j=>tramosLayer.addData(j));

//////////////////////////////////////////////////
// CONTROL DE CAPAS
//////////////////////////////////////////////////
L.control.layers(null,{
  'Clusters â€“ Fallecidos':clustersLayer,
  'Tramos de Alta Siniestralidad':tramosLayer,
  'Concesiones':concesionesLayer,
  'Red Vial Nacional':rvnLayer,
  'Departamentos':departamentosLayer
},{collapsed:true}).addTo(map);

//////////////////////////////////////////////////
// LEYENDA
//////////////////////////////////////////////////
var legend=L.control({position:'bottomleft'});
function construirLeyenda(){
  legend.onAdd=function(){
    var d=L.DomUtil.create('div','legend collapsed');
    var h=L.DomUtil.create('div','legend-header',d);
    h.innerHTML='LEYENDA <span>â˜°</span>';
    var b=L.DomUtil.create('div','legend-body',d);

    b.innerHTML+=`
      <div class="legend-title">Fallecidos por clÃºster</div>
      <div class="legend-row"><span class="swatch" style="background:#fee5d9"></span>1â€“5</div>
      <div class="legend-row"><span class="swatch" style="background:#fb6a4a"></span>6â€“10</div>
      <div class="legend-row"><span class="swatch" style="background:#de2d26"></span>11â€“15</div>
      <div class="legend-row"><span class="swatch" style="background:#a50f15"></span>16â€“20</div>
      <div class="legend-row"><span class="swatch" style="background:#67000d"></span>â‰¥21</div>
      <div class="legend-title">Concesiones</div>
    `;

    Object.keys(adminColorMap).sort().forEach(a=>{
      b.innerHTML+=`
        <div class="legend-row">
          <span class="swatch" style="background:${adminColorMap[a]}"></span>${a}
        </div>`;
    });

    b.innerHTML+=`
      <div class="legend-row"><span class="swatch line" style="background:#f4ae18"></span>Tramos Alta Siniestralidad</div>
      <div class="legend-row"><span class="swatch line" style="background:#8d6e63"></span>Red Vial Nacional</div>
      <div class="legend-row"><span class="swatch dashed"></span>Departamentos</div>
    `;

    L.DomEvent.on(h,'click',()=>d.classList.toggle('collapsed'));
    return d;
  };
  legend.addTo(map);
}
</script>
</body>
</html>
