<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mapa interactivo – Siniestros fatales RVN</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.polylinemeasure/Leaflet.PolylineMeasure.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css">

<style>
html, body { height:100%; margin:0; }
#map { height:100vh; width:100%; }

/* ===== LEYENDA ===== */
.legend{
  background:rgba(255,255,255,0.95);
  padding:10px 12px;
  border-radius:8px;
  box-shadow:0 2px 10px rgba(0,0,0,0.15);
  font:12px/1.35 system-ui, Arial;
  max-height:50vh;
  overflow:auto;
  display:none;
}
.legend.open{ display:block; }

.legend-toggle{
  background:#fff;
  border-radius:6px;
  padding:6px 10px;
  cursor:pointer;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
  font-size:13px;
}

.legend-title{
  font-weight:700;
  margin:10px 0 6px;
  border-bottom:1px solid #ddd;
}
.legend-row{
  display:flex;
  align-items:center;
  gap:8px;
  margin:4px 0;
}
.swatch{
  width:14px; height:14px;
  border-radius:3px;
  border:1px solid rgba(0,0,0,0.25);
}
.swatch.line{ height:4px; border:none; }
.swatch.dashed{
  background:none;
  border:2px dashed #333;
  height:10px;
}

/* ===== BOTONES ===== */
.leaflet-control.custom-btn{
  background:#fff;
  padding:6px;
  border-radius:6px;
  cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,0.25);
  font-size:14px;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.polylinemeasure/Leaflet.PolylineMeasure.js"></script>
<script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>
<script src="https://unpkg.com/leaflet-easyprint@2.1.9/dist/bundle.js"></script>

<script>
//////////////////////////////////////////////////
// MAPA BASE
//////////////////////////////////////////////////
var map = L.map('map').setView([-9.2, -75], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

//////////////////////////////////////////////////
// CONTROLES BASE
//////////////////////////////////////////////////
L.control.polylineMeasure({
  position:'topleft',
  unit:'metres',
  clearMeasurementsOnStop:false,
  showClearControl:true
}).addTo(map);

L.control.scale({ metric:true, imperial:false }).addTo(map);

new L.Control.MiniMap(
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
  {toggleDisplay:true, minimized:true}
).addTo(map);

//////////////////////////////////////////////////
// PANES
//////////////////////////////////////////////////
map.createPane('paneConcesiones');   map.getPane('paneConcesiones').style.zIndex = 200;
map.createPane('paneDepartamentos'); map.getPane('paneDepartamentos').style.zIndex = 300;
map.createPane('paneRVN');           map.getPane('paneRVN').style.zIndex = 350;
map.createPane('paneClusters');      map.getPane('paneClusters').style.zIndex = 450;
map.createPane('paneTramos');        map.getPane('paneTramos').style.zIndex = 500;

//////////////////////////////////////////////////
// COLORES
//////////////////////////////////////////////////
function colorByFallecidos(v){
  if(v>=21) return '#67000d';
  if(v>=16) return '#a50f15';
  if(v>=11) return '#de2d26';
  if(v>=6)  return '#fb6a4a';
  if(v>=1)  return '#fee5d9';
  return '#ccc';
}

var adminColorMap={}, adminColors=[
 '#1f78b4','#33a02c','#e31a1c','#ff7f00','#6a3d9a',
 '#a6cee3','#b2df8a','#fb9a99','#fdbf6f','#cab2d6'
];
function colorByAdmin(a){
  if(!adminColorMap[a]){
    adminColorMap[a]=adminColors[Object.keys(adminColorMap).length % adminColors.length];
  }
  return adminColorMap[a];
}

//////////////////////////////////////////////////
// CAPAS
//////////////////////////////////////////////////
var concesionesLayer = L.geoJSON(null,{
  pane:'paneConcesiones',
  style:f=>({ color:colorByAdmin(f.properties.ADM_VALIDO), weight:4 }),
  onEachFeature:(f,l)=>l.bindTooltip(f.properties.ADM_VALIDO,{sticky:true})
}).addTo(map);

fetch('data/concesiones.geojson')
  .then(r=>r.json())
  .then(j=>{ concesionesLayer.addData(j); construirLeyenda(); });

var rvnLayer = L.geoJSON(null,{
  pane:'paneRVN',
  style:{ color:'#8d6e63', weight:2 },
  onEachFeature:(f,l)=>l.bindTooltip(f.properties.cCodRuta,{sticky:true})
}).addTo(map);
fetch('data/rvn.geojson').then(r=>r.json()).then(j=>rvnLayer.addData(j));

var departamentosLayer = L.geoJSON(null,{
  pane:'paneDepartamentos',
  style:{ color:'#222', dashArray:'4 4', fill:false }
}).addTo(map);
fetch('data/departamentos.geojson').then(r=>r.json()).then(j=>departamentosLayer.addData(j));

//////////////////////////////////////////////////
// CONTROL DE CAPAS CON ÍCONO
//////////////////////////////////////////////////
var capasControl = L.control.layers(null,{
  'Concesiones':concesionesLayer,
  'RVN':rvnLayer,
  'Departamentos':departamentosLayer
},{collapsed:true});
capasControl.addTo(map);

//////////////////////////////////////////////////
// EXPORTAR MAPA
//////////////////////////////////////////////////
L.easyPrint({
  title:'Exportar mapa',
  position:'topright',
  sizeModes:['A4Portrait','Current'],
  exportOnly:true
}).addTo(map);

//////////////////////////////////////////////////
// LEYENDA COLAPSABLE
//////////////////////////////////////////////////
var legend = L.control({position:'bottomleft'});
legend.onAdd=function(){
  var div=L.DomUtil.create('div');
  div.innerHTML=`
    <div class="legend-toggle">☰ Leyenda</div>
    <div class="legend" id="legendBox"></div>`;
  return div;
};
legend.addTo(map);

function construirLeyenda(){
  var box=document.getElementById('legendBox');
  var admins=Object.keys(adminColorMap).sort();

  box.innerHTML=`
    <div class="legend-title">Concesiones</div>
    ${admins.map(a=>`
      <div class="legend-row">
        <span class="swatch" style="background:${adminColorMap[a]}"></span>${a}
      </div>`).join('')}
  `;
}

document.addEventListener('click',e=>{
  if(e.target.classList.contains('legend-toggle')){
    document.getElementById('legendBox').classList.toggle('open');
  }
});
</script>
</body>
</html>
