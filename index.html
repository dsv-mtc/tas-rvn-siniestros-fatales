<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mapa interactivo – Siniestros fatales RVN</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.polylinemeasure/Leaflet.PolylineMeasure.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css">

<style>
html, body { height:100%; margin:0; }
#map { height:100vh; width:100%; }

/* ================= LEYENDA ================= */
.legend{
  background:rgba(255,255,255,0.95);
  padding:0;
  border-radius:8px;
  box-shadow:0 2px 10px rgba(0,0,0,0.15);
  font:12px/1.35 system-ui, Arial;
  width:260px;
  overflow:hidden;
  z-index:1200 !important;
}
.legend-header{
  padding:10px 12px;
  font-weight:700;
  background:#f4f4f4;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.legend-body{
  padding:10px 12px;
  max-height:28vh;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}
.legend-title{
  font-weight:700;
  margin:10px 0 6px;
  border-bottom:1px solid #ddd;
}
.legend-row{
  display:flex;
  align-items:center;
  gap:8px;
  margin:4px 0;
}
.swatch{
  width:14px;
  height:14px;
  border-radius:3px;
  border:1px solid rgba(0,0,0,0.25);
}
.swatch.line{ height:4px; border:none; }
.swatch.dashed{
  background:none;
  border:2px dashed #333;
  height:10px;
}
.legend.collapsed .legend-body{ display:none; }
.legend-header span{ font-size:14px; opacity:0.7; }

@media (max-width: 768px){
  .legend{ width:90vw; max-width:300px; }
  .legend-header{ padding:8px 10px; font-size:12px; }
  .legend-body{ max-height:45vh; padding:6px 10px; }
  .legend-title{ margin:6px 0 4px; font-size:11px; }
  .legend-row{ margin:2px 0; gap:6px; }
  .swatch{ width:12px; height:12px; }
}

.leaflet-control-scale{ z-index:1100 !important; }
.leaflet-control-minimap{ z-index:1050 !important; }
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.polylinemeasure/Leaflet.PolylineMeasure.js"></script>
<script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>

<script>
//////////////////////////////////////////////////
// MAPA BASE  (CLAVE: preferCanvas true)
//////////////////////////////////////////////////
var map = L.map('map', { preferCanvas: true }).setView([-9.2, -75], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

//////////////////////////////////////////////////
// CONTROLES
//////////////////////////////////////////////////
L.control.polylineMeasure({
  position:'topleft',
  unit:'metres',
  tooltipTextFinish:'Doble clic para terminar'
}).addTo(map);

L.control.scale({
  position:'bottomright',
  metric:true,
  imperial:false
}).addTo(map);

new L.Control.MiniMap(
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
  {toggleDisplay:true, minimized:true, position:'bottomright'}
).addTo(map);

//////////////////////////////////////////////////
// PANES
//////////////////////////////////////////////////
map.createPane('paneConcesiones');   map.getPane('paneConcesiones').style.zIndex = 200;
map.createPane('paneDepartamentos'); map.getPane('paneDepartamentos').style.zIndex = 300;
map.createPane('paneRVN');           map.getPane('paneRVN').style.zIndex = 350;
map.createPane('paneClusters');      map.getPane('paneClusters').style.zIndex = 450;
map.createPane('paneTramos');        map.getPane('paneTramos').style.zIndex = 500;

//////////////////////////////////////////////////
// COLORES
//////////////////////////////////////////////////
function colorByFallecidos(v){
  if(v>=21) return '#67000d';
  if(v>=16) return '#a50f15';
  if(v>=11) return '#de2d26';
  if(v>=6)  return '#fb6a4a';
  if(v>=1)  return '#fee5d9';
  return '#ccc';
}

var adminColorMap={}, adminColors=[
 '#1f78b4','#33a02c','#e31a1c','#ff7f00','#6a3d9a',
 '#a6cee3','#b2df8a','#fb9a99','#fdbf6f','#cab2d6'
];
function colorByAdmin(a){
  if(!adminColorMap[a]){
    adminColorMap[a]=adminColors[Object.keys(adminColorMap).length % adminColors.length];
  }
  return adminColorMap[a];
}

//////////////////////////////////////////////////
// CAPAS (SE CREAN UNA SOLA VEZ)
//////////////////////////////////////////////////

// Concesiones (ON)
var concesionesLayer = L.geoJSON(null,{
  pane:'paneConcesiones',
  renderer: L.canvas(),
  style:function(f){
    var a = (f.properties && f.properties.ADM_VALIDO) ? f.properties.ADM_VALIDO : 'N/D';
    return { color: colorByAdmin(a), weight: 4, opacity: 0.7 };
  },
  onEachFeature:function(f,l){
    var a = (f.properties && f.properties.ADM_VALIDO) ? f.properties.ADM_VALIDO : '-';
    l.bindTooltip('<b>Concesión:</b> '+a,{sticky:true});
  }
}).addTo(map);

// Departamentos (ON)
var departamentosLayer = L.geoJSON(null,{
  pane:'paneDepartamentos',
  renderer: L.canvas(),
  style:{ color:'#222', weight:1.2, fill:false, dashArray:'4 4' },
  onEachFeature:function(f,l){
    var d = (f.properties && f.properties.NOMBDEP) ? f.properties.NOMBDEP : '-';
    l.bindTooltip('<b>Departamento:</b> '+d,{sticky:true});
  }
}).addTo(map);

// RVN (ON)
var rvnLayer = L.geoJSON(null,{
  pane:'paneRVN',
  renderer: L.canvas(),
  style:{ color:'#8d6e63', weight:2, opacity:0.85 },
  onEachFeature:function(f,l){
    var r = (f.properties && f.properties.cCodRuta) ? f.properties.cCodRuta : '-';
    l.bindTooltip('<b>Ruta:</b> '+r,{sticky:true});
  }
}).addTo(map);

// Clusters (ON)
var clusterTotals = {};
var clusterCounts = {};
var clustersLayer = L.geoJSON(null,{
  pane:'paneClusters',
  renderer: L.canvas(),
  pointToLayer:function(f,ll){
    var id = f.properties ? f.properties.CLUSTER_ID : null;
    var fal = clusterTotals[id] || 0;
    return L.circleMarker(ll,{
      radius:6,
      fillColor:colorByFallecidos(fal),
      color:'#111',
      weight:1,
      fillOpacity:0.75
    });
  },
  onEachFeature:function(f,l){
    var id = f.properties ? f.properties.CLUSTER_ID : '-';
    l.bindTooltip(
      '<b>Cluster:</b> '+id+
      '<br><b>Siniestros:</b> '+(clusterCounts[id]||0)+
      '<br><b>Fallecidos:</b> '+(clusterTotals[id]||0),
      {sticky:true}
    );
  }
}).addTo(map);

// Tramos (OFF al inicio)
var tramosLayer = L.geoJSON(null,{
  pane:'paneTramos',
  renderer: L.canvas(),
  style:{ color:'#f4ae18', weight:5, opacity:0.9 },
  onEachFeature:function(f,l){
    var p = f.properties || {};
    var m = Number(p.Longitud_m || 0).toFixed(0);
    l.bindTooltip(
      '<b>Tramo Alta Siniestralidad</b><br>' +
      '<b>Cluster:</b> ' + (p.CLUSTER_ID || '-') + '<br>' +
      '<b>Siniestros:</b> ' + (p.Siniestros || p.Siniestros_Total || '-') + '<br>' +
      '<b>Fallecidos:</b> ' + (p.Fallecidos || '-') + '<br>' +
      '<b>Longitud:</b> ' + m + ' m',
      { sticky:true }
    );
  }
}); // NOT addTo(map)

//////////////////////////////////////////////////
// CONTROL DE CAPAS (UNA SOLA VEZ, con referencias estables)
//////////////////////////////////////////////////
L.control.layers(null,{
  'Clusters – Fallecidos': clustersLayer,
  'Tramos de Alta Siniestralidad': tramosLayer,
  'Concesiones': concesionesLayer,
  'Red Vial Nacional': rvnLayer,
  'Departamentos': departamentosLayer
},{collapsed:true}).addTo(map);

//////////////////////////////////////////////////
// LEYENDA UNIFICADA (SIEMPRE SE CREA)
// (antes dependía de concesiones => en móvil “aparecía tarde”)
//////////////////////////////////////////////////
var legend = L.control({position:'bottomleft'});
legend.onAdd = function(){
  var d = L.DomUtil.create('div','legend');
  var header = L.DomUtil.create('div','legend-header', d);
  header.innerHTML = 'LEYENDA <span>☰</span>';

  var body = L.DomUtil.create('div','legend-body', d);
  L.DomEvent.disableScrollPropagation(body);
  L.DomEvent.disableClickPropagation(d);

  body.innerHTML += `
    <div class="legend-title">Fallecidos por clúster</div>
    <div class="legend-row"><span class="swatch" style="background:#fee5d9"></span>1–5</div>
    <div class="legend-row"><span class="swatch" style="background:#fb6a4a"></span>6–10</div>
    <div class="legend-row"><span class="swatch" style="background:#de2d26"></span>11–15</div>
    <div class="legend-row"><span class="swatch" style="background:#a50f15"></span>16–20</div>
    <div class="legend-row"><span class="swatch" style="background:#67000d"></span>≥21</div>
    <div class="legend-title">Concesiones</div>
    <div id="legendConcesiones"></div>
    <div class="legend-title"></div>
    <div class="legend-row"><span class="swatch line" style="background:#f4ae18"></span>Tramos Alta Siniestralidad</div>
    <div class="legend-row"><span class="swatch line" style="background:#8d6e63"></span>Red Vial Nacional</div>
    <div class="legend-row"><span class="swatch dashed"></span>Departamentos</div>
  `;

  header.setAttribute('role','button');
  header.setAttribute('aria-label','Mostrar u ocultar leyenda');

  L.DomEvent.on(header,'click',function(){
    d.classList.toggle('collapsed');
  });

  // en móvil, inicia colapsada
  if (window.innerWidth < 768) d.classList.add('collapsed');

  return d;
};
legend.addTo(map);

function refrescarLeyendaConcesiones(){
  var cont = document.getElementById('legendConcesiones');
  if (!cont) return;
  cont.innerHTML = '';
  Object.keys(adminColorMap).sort().forEach(function(a){
    var row = document.createElement('div');
    row.className = 'legend-row';
    var sw = document.createElement('span');
    sw.className = 'swatch';
    sw.style.background = adminColorMap[a];
    row.appendChild(sw);
    row.appendChild(document.createTextNode(a));
    cont.appendChild(row);
  });
}

//////////////////////////////////////////////////
// FETCHES (solo cargan data a las capas ya creadas)
//////////////////////////////////////////////////

fetch('data/concesiones.geojson').then(r=>r.json()).then(j=>{
  concesionesLayer.addData(j);
  // adminColorMap ya se llenó durante el style -> ahora pintamos la leyenda
  refrescarLeyendaConcesiones();
});

fetch('data/departamentos.geojson').then(r=>r.json()).then(j=>{
  departamentosLayer.addData(j);
});

fetch('data/rvn.geojson').then(r=>r.json()).then(j=>{
  rvnLayer.addData(j);
});

fetch('data/tramos-siniestros.geojson').then(r=>r.json()).then(j=>{
  tramosLayer.addData(j);
});

fetch('data/clusters.geojson').then(r=>r.json()).then(j=>{
  // precalcular totales
  clusterTotals = {};
  clusterCounts = {};
  j.features.forEach(function(f){
    var id = f.properties ? f.properties.CLUSTER_ID : null;
    if (id == null) return;
    clusterTotals[id] = (clusterTotals[id]||0) + Number((f.properties.Fallecidos||0));
    clusterCounts[id] = (clusterCounts[id]||0) + 1;
  });

  clustersLayer.addData(j);
  try { map.fitBounds(clustersLayer.getBounds(),{padding:[20,20]}); } catch(e){}
});
</script>
</body>
</html>
