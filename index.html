<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Mapa interactivo – Siniestros fatales RVN</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-polylinemeasure/Leaflet.PolylineMeasure.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css"/>

<style>
html, body { height:100%; margin:0; padding:0; overflow:hidden; }
#map { height:100vh; width:100%; background:#e0e0e0; }

/* FIX tiles */
.leaflet-tile-pane img, .leaflet-tile {
    max-width:none !important;
    max-height:none !important;
}

.legend-container{
    background:rgba(255,255,255,0.95);
    border-radius:8px;
    box-shadow:0 2px 10px rgba(0,0,0,.25);
    font:12px system-ui;
    width:260px;
    overflow:hidden;
}
.legend-header{
    padding:10px;
    font-weight:700;
    background:#f2f2f2;
    cursor:pointer;
    display:flex;
    justify-content:space-between;
}
.legend-body{ padding:10px; max-height:50vh; overflow:auto; }
.legend-container.collapsed .legend-body{ display:none; }

.legend-title{
    font-size:11px;
    font-weight:700;
    margin:10px 0 5px;
    border-bottom:1px solid #ddd;
}
.legend-row{ display:flex; align-items:center; gap:8px; margin:4px 0; }
.swatch{ width:14px; height:14px; border:1px solid #333; }
.swatch.line{ height:4px; border:none; }
.swatch.dashed{ background:none; border:2px dashed #333; height:10px; }

.coord-box input, .coord-box button{
    width:100%; padding:6px; margin-top:4px;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-polylinemeasure/Leaflet.PolylineMeasure.js"></script>
<script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>

<script>
/* ===============================
   MAPA BASE
================================ */
var map = L.map('map',{ zoomControl:false }).setView([-9.2,-75],6);
L.control.zoom({position:'topright'}).addTo(map);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'© OpenStreetMap'
}).addTo(map);

L.control.scale({metric:true, imperial:false}).addTo(map);
L.control.polylineMeasure({unit:'metres'}).addTo(map);

new L.Control.MiniMap(
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
  {toggleDisplay:true, minimized:true}
).addTo(map);

/* ===============================
   PANES
================================ */
map.createPane('concesiones').style.zIndex=200;
map.createPane('departamentos').style.zIndex=300;
map.createPane('rvn').style.zIndex=350;
map.createPane('clusters').style.zIndex=450;
map.createPane('tramos').style.zIndex=500;

/* ===============================
   HELPERS
================================ */
function colorByFallecidos(v){
  if(v>=21) return '#67000d';
  if(v>=16) return '#a50f15';
  if(v>=11) return '#de2d26';
  if(v>=6) return '#fb6a4a';
  if(v>=1) return '#fee5d9';
  return '#ccc';
}

var adminColors=[
 '#1f78b4','#33a02c','#e31a1c','#ff7f00','#6a3d9a',
 '#a6cee3','#b2df8a','#fb9a99','#fdbf6f','#cab2d6'
];
var adminMap={};

function colorByAdmin(a){
  if(!adminMap[a]){
    adminMap[a]=adminColors[Object.keys(adminMap).length % adminColors.length];
  }
  return adminMap[a];
}

function safeFetch(url){
  return fetch(url)
    .then(r=>{
      if(!r.ok) throw new Error(`❌ No se pudo cargar ${url}`);
      return r.json();
    })
    .catch(e=>{
      console.error(e.message);
      return null;
    });
}

/* ===============================
   CAPAS
================================ */
var concesiones = L.geoJSON(null,{pane:'concesiones'}).addTo(map);
var departamentos = L.geoJSON(null,{pane:'departamentos'}).addTo(map);
var rvn = L.geoJSON(null,{pane:'rvn'}).addTo(map);
var clusters = L.geoJSON(null,{pane:'clusters'}).addTo(map);
var tramos = L.geoJSON(null,{pane:'tramos'});

/* ===============================
   CONTROL CAPAS
================================ */
L.control.layers(null,{
  'Clusters – Fallecidos':clusters,
  'Tramos Alta Siniestralidad':tramos,
  'Concesiones':concesiones,
  'Red Vial Nacional':rvn,
  'Departamentos':departamentos
},{collapsed:true}).addTo(map);

/* ===============================
   LEYENDA
================================ */
var legend=L.control({position:'bottomleft'});
legend.onAdd=function(){
  var d=L.DomUtil.create('div','legend-container');
  d.innerHTML=`
  <div class="legend-header" onclick="this.parentElement.classList.toggle('collapsed')">
    LEYENDA <span>▼</span>
  </div>
  <div class="legend-body">
    <div class="legend-title">Clusters (fallecidos)</div>
    <div class="legend-row"><span class="swatch" style="background:#67000d"></span> ≥21</div>
    <div class="legend-row"><span class="swatch" style="background:#a50f15"></span> 16–20</div>
    <div class="legend-row"><span class="swatch" style="background:#de2d26"></span> 11–15</div>
    <div class="legend-row"><span class="swatch" style="background:#fb6a4a"></span> 6–10</div>
    <div class="legend-row"><span class="swatch" style="background:#fee5d9"></span> 1–5</div>

    <div class="legend-title">Concesiones</div>
    <div id="admList">Cargando…</div>

    <div class="legend-title">Ir a coordenadas</div>
    <div class="coord-box">
      <input id="lat" placeholder="Lat">
      <input id="lon" placeholder="Lon">
      <button onclick="goCoord()">Ir</button>
    </div>
  </div>`;
  L.DomEvent.disableClickPropagation(d);
  return d;
};
legend.addTo(map);

function goCoord(){
  var lat=parseFloat(document.getElementById('lat').value);
  var lon=parseFloat(document.getElementById('lon').value);
  if(isNaN(lat)||isNaN(lon)){ alert('Coordenadas inválidas'); return; }
  map.setView([lat,lon],14);
  L.marker([lat,lon]).addTo(map);
}

/* ===============================
   CARGA DATOS
================================ */

// CONCESIONES
safeFetch('data/concesiones.geojson').then(j=>{
  if(!j) return;
  concesiones.addData(j);
  concesiones.eachLayer(l=>{
    var a=l.feature.properties.ADM_VALIDO||'N/D';
    l.setStyle({color:colorByAdmin(a),weight:4});
    l.bindTooltip(a,{sticky:true});
  });
  var list=document.getElementById('admList');
  list.innerHTML='';
  Object.keys(adminMap).forEach(a=>{
    list.innerHTML+=`<div class="legend-row"><span class="swatch" style="background:${adminMap[a]}"></span>${a}</div>`;
  });
});

// DEPARTAMENTOS
safeFetch('data/departamentos.geojson').then(j=>{
  if(!j) return;
  departamentos.addData(j);
  departamentos.setStyle({color:'#222',weight:1,fill:false,dashArray:'4 4'});
});

// RVN
safeFetch('data/rvn.geojson').then(j=>{
  if(!j) return;
  rvn.addData(j);
  rvn.setStyle({color:'#aaa',weight:1.8});
});

// CLUSTERS
var totals={};
safeFetch('data/clusters.geojson').then(j=>{
  if(!j) return;
  j.features.forEach(f=>{
    totals[f.properties.CLUSTER_ID]=(totals[f.properties.CLUSTER_ID]||0)+(+f.properties.Fallecidos||0);
  });
  clusters.options.pointToLayer=(f,ll)=>L.circleMarker(ll,{
    radius:6,
    fillColor:colorByFallecidos(totals[f.properties.CLUSTER_ID]),
    color:'#111',fillOpacity:.75
  });
  clusters.addData(j);
  map.fitBounds(clusters.getBounds(),{padding:[20,20]});
});

// TRAMOS
safeFetch('data/tramos-siniestros.geojson').then(j=>{
  if(!j) return;
  tramos.addData(j);
  tramos.setStyle({color:'#f4ae18',weight:5});
});
</script>
</body>
</html>
