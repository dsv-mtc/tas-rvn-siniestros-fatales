<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mapa interactivo – Siniestros fatales RVN</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; }

    .legend {
      background: rgba(255,255,255,0.95);
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      font: 12px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .legend-title { font-weight: 700; margin-bottom: 6px; }
    .legend-row { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .swatch { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.2); }
  </style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const map = L.map('map', { zoomControl: true }).setView([-9.2, -75.0], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // ====== 1) CLUSTERS (coloreado por Nº de siniestros fatales) ======
  // Ajusta los rangos si quieres que calcen 1:1 con tu reporte final
  function colorBySiniestros(v) {
    if (v >= 20) return '#7f0000';
    if (v >= 15) return '#b30000';
    if (v >= 10) return '#e34a33';
    if (v >=  5) return '#fc8d59';
    return '#fee8c8';
  }

  const clustersLayer = L.geoJSON(null, {
    style: f => {
      const v = Number(f?.properties?.Siniestros_Total ?? 0);
      return { color: colorBySiniestros(v), weight: 5, opacity: 0.95 };
    },
    onEachFeature: (f, layer) => {
      const p = f.properties || {};
      layer.bindPopup(`
        <b>Cluster:</b> ${p.CLUSTER_ID ?? '-'}<br>
        <b>Tramo:</b> ${p.TRAMO ?? '-'}<br>
        <b>Ruta:</b> ${p.cCodRuta ?? '-'}<br>
        <b>Siniestros fatales:</b> ${p.Siniestros_Total ?? '-'}<br>
        <b>Fallecidos:</b> ${p.Fallecidos ?? '-'}<br>
        <b>Longitud (km):</b> ${p.Longitud_km ?? '-'}<br>
        <b>Administra:</b> ${p.ADM_VALIDO ?? '-'}
      `);
    }
  });

  fetch('data/clusters.geojson')
    .then(r => r.json())
    .then(j => {
      clustersLayer.addData(j);
      clustersLayer.addTo(map);
      try { map.fitBounds(clustersLayer.getBounds(), { padding: [20, 20] }); } catch(e) {}
    });

  // ====== 2) CONCESIONES (Administra) ======
  // Por ahora un estilo único; en el siguiente paso lo coloreamos por concesionaria
  const concesionesLayer = L.geoJSON(null, {
    style: f => ({ color: '#1f78b4', weight: 2, opacity: 0.8 }),
    onEachFeature: (f, layer) => {
      const p = f.properties || {};
      const admin = p.Administra ?? p.ADM_VALIDO ?? p.ADMINISTRA ?? '-';
      layer.bindPopup(<b>Administra:</b> ${admin});
    }
  });

  fetch('data/concesiones.geojson')
    .then(r => r.json())
    .then(j => {
      concesionesLayer.addData(j);
      concesionesLayer.addTo(map);
    });

  // ====== Control de capas ======
  L.control.layers(
    null,
    {
      "Número de siniestros fatales (clusters)": clustersLayer,
      "Concesiones (Administra)": concesionesLayer
    },
    { collapsed: false }
  ).addTo(map);

  // ====== Leyenda 1: Número de siniestros fatales ======
  const legendSiniestros = L.control({ position: 'bottomright' });
  legendSiniestros.onAdd = function() {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
      <div class="legend-title">Número de siniestros fatales</div>
      <div class="legend-row"><span class="swatch" style="background:${colorBySiniestros(1)}"></span> 1 – 4</div>
      <div class="legend-row"><span class="swatch" style="background:${colorBySiniestros(5)}"></span> 5 – 9</div>
      <div class="legend-row"><span class="swatch" style="background:${colorBySiniestros(10)}"></span> 10 – 14</div>
      <div class="legend-row"><span class="swatch" style="background:${colorBySiniestros(15)}"></span> 15 – 19</div>
      <div class="legend-row"><span class="swatch" style="background:${colorBySiniestros(20)}"></span> ≥ 20</div>
    `;
    return div;
  };
  legendSiniestros.addTo(map);

  // ====== Leyenda 2: Administra (placeholder) ======
  // En el siguiente paso la hacemos dinámica con colores por concesionaria.
  const legendAdmin = L.control({ position: 'bottomleft' });
  legendAdmin.onAdd = function() {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
      <div class="legend-title">Concesiones (Administra)</div>
      <div class="legend-row"><span class="swatch" style="background:#1f78b4"></span> Tramos concesionados</div>
    `;
    return div;
  };
  legendAdmin.addTo(map);
</script>
</body>
</html>